#!/bin/bash
#SBATCH --job-name=p000.preprocess
#SBATCH --output=log.preprocess
#SBATCH --mail-user=example@example.com
#SBATCH --mail-type=END
#SBATCH --ntasks=1
#SBATCH --mem-per-cpu=64G
#SBATCH --partition=medpri,k2-medpri


echo "************************ Preprocessing Precursor ************************"

# WARNING: 0 folder will be DELETED. 0.original folder must exist.
# WARNING: Existing mesh and processor folders will be DELETED.

# User Input
cores=1              # Enter the number of cores you will preprocess on.
                     # If cores is 1, preprocessing will be done in serial.

refinementLevels=0   # If you are making a uniform resolution mesh that is so
                     # large that you need to build it in serial at lower
                     # resolution and then globally refine, set the number of
                     # refinement levels here. In most cases, though, you
                     # probably will not be refining, so keep this set to 0.


refineMeshGlobal() # Global mesh refinement. Performed when running in parallel.
{
   i=1
   while [ $i -le $1 ]; do
      echo "   -Performing level $i global refinement with refineMesh"
      echo "      *refining cells..."
      mpirun -np $cores refineMesh -all -parallel -overwrite > log.refineMesh.global.$i 2>&1

      let i=i+1
   done
}


# Set Environment
source $HOME/.bashrc
sowfa24x || exit 1

# SOWFA uses controlDict.$runNumber. OpenfOAM uses controlDict
cp system/controlDict.1 system/controlDict || exit 1

rm -rf 0
cp -rf 0.original 0

echo "Runnning blockMesh..."
cp constant/polyMesh/blockMeshDict ./
rm -rf constant/polyMesh/*
mv ./blockMeshDict constant/polyMesh
blockMesh > log.blockMesh 2>&1


if [ $cores -gt 1 ]; then
   echo "Running decomposePar..."
   decomposePar -cellDist -force > log.decomposePar 2>&1

   echo "Operating in parallel from this point"

   echo "Running checkMesh..."
   mpirun -np $cores checkMesh -parallel > log.checkMesh.1 2>&1

   refineMeshGlobal $refinementLevels

   echo "Running renumberMesh..."
   mpirun -np $cores renumberMesh -parallel -overwrite > log.renumberMesh 2>&1

   echo "Running checkMesh..."
   mpirun -np $cores checkMesh -parallel > log.checkMesh.2 2>&1


else 
   echo "Operating in serial"

   echo "Running renumberMesh..."
   renumberMesh -overwrite > log.renumberMesh 2>&1

   echo "Running decomposePar..."
   decomposePar -cellDist -force > log.decomposePar 2>&1

   echo "Running checkMesh..."
   checkMesh > log.checkMesh 2>&1
fi

rm system/controlDict

echo "************************ Finished Preprocessing *************************"
